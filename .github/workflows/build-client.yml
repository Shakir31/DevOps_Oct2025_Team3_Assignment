name: Build frontend folder

on:
  pull_request:
    branches: [main]

defaults:
  run:
    shell: bash
    working-directory: ./frontend

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node (Security Checks)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install tools (jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Define Security Gates
        run: |
          echo "SECURITY_GATES_ACTIVATED=true" >> $GITHUB_ENV
          echo "MAX_VULNERABILITIES=0" >> $GITHUB_ENV
          echo "MAX_CRITICAL=0" >> $GITHUB_ENV
          echo "MAX_HIGH=0" >> $GITHUB_ENV

      - name: Frontend Security Scan (npm audit)
        id: frontend-scan
        run: |
          npm ci

          # Run audit. npm audit returns non-zero when vulns exist, so we allow the command to fail
          npm audit --audit-level=high --json > audit-report.json || true

          # Handle cases where metadata may be missing
          vulnerabilities=$(jq -r '.metadata.vulnerabilities.total // 0' audit-report.json)
          critical=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-report.json)
          high=$(jq -r '.metadata.vulnerabilities.high // 0' audit-report.json)

          echo "vulnerabilities=$vulnerabilities" >> $GITHUB_OUTPUT
          echo "critical=$critical" >> $GITHUB_OUTPUT
          echo "high=$high" >> $GITHUB_OUTPUT

          echo "Vulnerabilities total: $vulnerabilities"
          echo "Critical: $critical"
          echo "High: $high"

          # Fail if criteria not met
          if [[ "$critical" -gt 0 ]] || [[ "$high" -gt 0 ]]; then
            echo "âŒ SECURITY GATE FAILED: Critical or High vulnerabilities found"
            exit 1
          fi

      - name: Email teachers (security job)
        if: always()
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          STATUS: ${{ job.status }}
          WORKFLOW: ${{ github.workflow }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.head_ref }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          sudo apt-get update
          sudo apt-get install -y msmtp msmtp-mta

          cat > ~/.msmtprc <<EOF
          defaults
          auth on
          tls on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt

          account smtp
          host $SMTP_HOST
          port $SMTP_PORT
          user $SMTP_USER
          password $SMTP_PASS
          from $EMAIL_FROM

          account default : smtp
          EOF

          chmod 600 ~/.msmtprc

          SUBJECT="[${STATUS^^}] ${WORKFLOW} (security-checks) - $REPO (${BRANCH})"
          BODY="Hello,\n\nThis is an automated CI notification.\n\nWorkflow: $WORKFLOW\nJob: security-checks\nRepository: $REPO\nPR Branch: $BRANCH\nTriggered by: $ACTOR\nStatus: $STATUS\n\nRun link: $RUN_URL\n\nRegards,\nDevOps Team"

          printf "To: %s\nFrom: %s\nSubject: %s\n\n%s\n" \
            "$EMAIL_TO" "$EMAIL_FROM" "$SUBJECT" "$BODY" | msmtp -t


  build:
    runs-on: ubuntu-latest
    needs: security-checks
    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Run frontend tests (placeholder)
        run: |
          npm test -- --passWithNoTests

      - name: Email teachers (build job)
        if: always()
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          STATUS: ${{ job.status }}
          WORKFLOW: ${{ github.workflow }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.head_ref }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          sudo apt-get update
          sudo apt-get install -y msmtp msmtp-mta

          cat > ~/.msmtprc <<EOF
          defaults
          auth on
          tls on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt

          account smtp
          host $SMTP_HOST
          port $SMTP_PORT
          user $SMTP_USER
          password $SMTP_PASS
          from $EMAIL_FROM

          account default : smtp
          EOF

          chmod 600 ~/.msmtprc

          SUBJECT="[${STATUS^^}] ${WORKFLOW} (build) - $REPO (${BRANCH})"
          BODY="Hello,\n\nThis is an automated CI notification.\n\nWorkflow: $WORKFLOW\nJob: build\nRepository: $REPO\nPR Branch: $BRANCH\nTriggered by: $ACTOR\nStatus: $STATUS\n\nRun link: $RUN_URL\n\nRegards,\nDevOps Team"

          printf "To: %s\nFrom: %s\nSubject: %s\n\n%s\n" \
            "$EMAIL_TO" "$EMAIL_FROM" "$SUBJECT" "$BODY" | msmtp -t
